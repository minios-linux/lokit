name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Get version from tag
        id: version
        run: |
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Build binaries
        run: |
          # Create dist directory
          mkdir -p dist
          
          # Build for multiple platforms
          platforms=(
            "linux/amd64"
            "linux/arm64"
            "darwin/amd64"
            "darwin/arm64"
            "windows/amd64"
          )
          
          for platform in "${platforms[@]}"; do
            GOOS=${platform%/*}
            GOARCH=${platform#*/}
            
            output_name="lokit-${{ steps.version.outputs.VERSION }}-${GOOS}-${GOARCH}"
            if [ "$GOOS" = "windows" ]; then
              output_name="${output_name}.exe"
            fi
            
            echo "Building for $GOOS/$GOARCH..."
            GOOS=$GOOS GOARCH=$GOARCH go build \
              -ldflags "-X 'main.version=${{ steps.version.outputs.VERSION }}' -X 'main.commit=${{ github.sha }}' -X 'main.date=$(date -u +"%Y-%m-%d %H:%M:%S UTC")'" \
              -o "dist/${output_name}"
            
            # Create tarball (except for Windows)
            if [ "$GOOS" = "windows" ]; then
              (cd dist && zip "${output_name%.exe}.zip" "${output_name}")
              rm "dist/${output_name}"
            else
              tar -czf "dist/${output_name}.tar.gz" -C dist "${output_name}"
              rm "dist/${output_name}"
            fi
          done
          
          # List built files
          ls -lh dist/

      - name: Generate changelog
        id: changelog
        run: |
          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$PREV_TAG" ]; then
            echo "First release"
            CHANGELOG="Initial release of lokit - Localization Kit with AI translation support"
          else
            echo "Generating changelog from $PREV_TAG to ${{ steps.version.outputs.TAG_NAME }}"
            CHANGELOG=$(git log --pretty=format:"- %s" ${PREV_TAG}..${{ steps.version.outputs.TAG_NAME }})
          fi
          
          # Save to file for release notes
          cat > release_notes.md << EOF
          ## What's New
          
          $CHANGELOG
          
          ## Installation
          
          Download the appropriate binary for your platform from the assets below.
          
          ### Linux/macOS
          \`\`\`bash
          # Download and extract
          tar -xzf lokit-${{ steps.version.outputs.VERSION }}-linux-amd64.tar.gz
          
          # Move to PATH
          sudo mv lokit-${{ steps.version.outputs.VERSION }}-linux-amd64 /usr/local/bin/lokit
          
          # Verify
          lokit version
          \`\`\`
          
          ### Windows
          \`\`\`powershell
          # Extract the zip file and add to PATH
          \`\`\`
          
          ## Supported Platforms
          
          - Linux (amd64, arm64)
          - macOS (amd64/Intel, arm64/Apple Silicon)
          - Windows (amd64)
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.TAG_NAME }}
          name: Release ${{ steps.version.outputs.VERSION }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            dist/*.tar.gz
            dist/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
